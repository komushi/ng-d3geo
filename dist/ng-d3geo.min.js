!function(){"use strict";function findprop(obj,path){var i,l,args=path.split(".");for(i=0,l=args.length;i<l;i++){if(!obj.hasOwnProperty(args[i]))return;obj=obj[args[i]]}return obj}angular.module("ngD3geo",["rx"]).directive("2layerMap",function($parse,$window,observeOnScope){return{restrict:"EA",scope:{data:"=",id:"@",topojsonPath:"@",width:"@",height:"@",layer1ColorRange:"@",center:"@",scale:"@",layer1Objects:"@",layer2Objects:"@",layer1FeatureName:"@",layer1FeatureCode:"@",layer2FeatureName:"@",layer2FeatureCode:"@"},template:"<svg></svg>",link:function(scope,elem,attrs){function reset(){active.classed("active",!1),active=d3.select(null),g.transition().duration(750).style("stroke-width","1.5px").attr("transform",""),gLayer1.selectAll("text").style("display","block")}var width=scope.width,height=scope.height,d3=$window.d3,tip=d3.tip().attr("class","d3-tip").offset([-30,0]).html(function(text){return"<span style='color:red'><strong>"+text+"</strong></span>"}),rawSvg=elem.find("svg"),svg=d3.select(rawSvg[0]).attr("width",width).attr("height",height).attr("style","outline: thin solid gray;");svg.append("rect").attr("class","background").attr("width",width).attr("height",height).on("click",reset);var g=svg.append("g").call(tip),gLayer2=g.append("g").attr("id",scope.layer2Objects),gLayer1=g.append("g").attr("id",scope.layer1Objects),projection=d3.geo.mercator().center(scope.center.split(",")).scale(scope.scale).translate([width/2,height/2]),path=d3.geo.path().projection(projection);d3.json(scope.topojsonPath,function(error,json){var layer1Featues=topojson.feature(json,json.objects[scope.layer1Objects]).features,layer2Featues=topojson.feature(json,json.objects[scope.layer2Objects]).features,meshLayer1=topojson.mesh(json,json.objects[scope.layer1Objects],function(a,b){return a!==b}),color=d3.scale.linear().domain([1,layer1Featues.length]).interpolate(d3.interpolateHcl).range(scope.layer1ColorRange.split(","));gLayer2.selectAll("path").data(layer2Featues).enter().append("path").attr("d",path).attr("layer1-feature-code",function(d){return findprop(d,scope.layer1FeatureCode)}).attr("layer1-feature-name",function(d){return findprop(d,scope.layer1FeatureName)}).attr("layer2-feature-code",function(d){return findprop(d,scope.layer2FeatureCode)}).attr("layer2-feature-name",function(d){return findprop(d,scope.layer2FeatureName)}).attr("class","layer2").on("click",layer2Clicked).on("mouseover",mouseoverLayer2).on("mouseout",mouseoutLayer2),gLayer1.selectAll("path").data(layer1Featues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",function(d,i){return color(i)}).attr("layer1-feature-code",function(d){return findprop(d,scope.layer1FeatureCode)}).attr("layer1-feature-name",function(d){return findprop(d,scope.layer1FeatureName)}).on("click",layer1Clicked),gLayer1.append("path").datum(meshLayer1).attr("d",path).attr("class","layer1-boundary"),gLayer1.selectAll("text").data(layer1Featues).enter().append("text").attr("class","layer1-label").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy",".35em").text(function(d){return findprop(d,scope.layer1FeatureName)}).attr("layer1-feature-code",function(d){return findprop(d,scope.layer1FeatureCode)}).on("click",labelClicked)});var active=d3.select(null),layer2Clicked=function(d){if(active.node()&&this.getAttribute("layer1-feature-code")==active.node().getAttribute("layer1-feature-code"))return reset()},labelClicked=function(d){var prevTagName=(this.tagName,""),currentID="";return active.node()&&(prevTagName=active.node().tagName,this.getAttribute("layer1-feature-code")==active.node().getAttribute("layer1-feature-code"))?reset():(currentID=this.getAttribute("layer1-feature-code"),active.classed("active",!1),active=g.selectAll(".layer1").filter(function(d){return findprop(d,scope.layer1FeatureCode)==currentID}).classed("active",!0),void zoom(d))},layer1Clicked=function(d){return active.node()===this?reset():(active.classed("active",!1),active=d3.select(this).classed("active",!0),void zoom(d))},zoom=function(d){var bounds=path.bounds(d),dx=bounds[1][0]-bounds[0][0],dy=bounds[1][1]-bounds[0][1],x=(bounds[0][0]+bounds[1][0])/2,y=(bounds[0][1]+bounds[1][1])/2,scale=.9/Math.max(dx/width,dy/height),translate=[width/2-scale*x,height/2-scale*y];g.transition().duration(750).style("stroke-width",1.5/scale+"px").attr("transform","translate("+translate+")scale("+scale+")");findprop(d,scope.layer1FeatureCode);gLayer1.selectAll("text").style("display","none")},mouseoverLayer2=function(p){tip.show(findprop(p,scope.layer1FeatureName)+" "+findprop(p,scope.layer2FeatureName))},mouseoutLayer2=function(){tip.hide()},duration=1500,styleCircle=g.selectAll("circle"),updateCircle=function(data){styleCircle.data(data).enter().append("circle").style("opacity",0).attr("class","circle").attr("cx",function(d){return projection(d)[0]}).attr("cy",function(d){return projection(d)[1]}).attr("r",1).transition().delay(function(d,i){return 100*i}).duration(duration).style("opacity",1).transition().delay(function(d,i){return 100*i+duration+100}).duration(duration).style("opacity",0).remove()};observeOnScope(scope,"data").subscribe(function(change){if(change.newValue&&change.oldValue)return updateCircle(change.newValue)})}}}).directive("zoomPanMap",function($parse,$window){return{restrict:"EA",scope:{data:"=",id:"@",topojsonPath:"@",width:"@",height:"@",colorRange:"@",center:"@",scale:"@",layerObjects:"@",layerFeatureName:"@",layerFeatureCode:"@",featureNameStyle:"@"},template:"<svg></svg>",link:function(scope,elem,attrs){var width=scope.width,height=scope.height,d3=$window.d3,rawSvg=elem.find("svg"),svg=d3.select(rawSvg[0]).attr("width",width).attr("height",height).attr("style","outline: thin solid gray;"),g=svg.append("g"),projection=d3.geo.mercator().center(scope.center.split(",")).scale(scope.scale).translate([width/2,height/2]),path=d3.geo.path().projection(projection);d3.json(scope.topojsonPath,function(error,json){var layerFeatues=topojson.feature(json,json.objects[scope.layerObjects]).features,mesh=topojson.mesh(json,json.objects[scope.layerObjects],function(a,b){return a!==b}),color=d3.scale.linear().domain([1,layerFeatues.length]).interpolate(d3.interpolateHcl).range(scope.colorRange.split(","));if("tip"==scope.featureNameStyle){var tip=d3.tip().attr("class","d3-tip").offset([0,0]).html(function(text){return"<span style='color:red'><strong>"+text+"</strong></span>"});"tip"==scope.featureNameStyle&&g.call(tip);var mouseover=function(p){tip.show(findprop(p,scope.layerFeatureName))},mouseout=function(p){tip.hide()};g.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",function(d,i){return color(i)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)}).attr("layer-feature-name",function(d){return findprop(d,scope.layerFeatureName)}).on("mouseover",mouseover).on("mouseout",mouseout),g.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary")}else if("fading"==scope.featureNameStyle){var mouseover=function(p){g.selectAll("text").filter(function(d){return findprop(p,scope.layerFeatureCode)==findprop(d,scope.layerFeatureCode)}).transition().duration(200).style("fill-opacity",1).style("display","block")},mouseout=function(p){g.selectAll("text").filter(function(d){return findprop(p,scope.layerFeatureCode)==findprop(d,scope.layerFeatureCode)}).transition().duration(200).style("fill-opacity",0).transition().style("display","none")};g.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",function(d,i){return color(i)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)}).attr("layer-feature-name",function(d){return findprop(d,scope.layerFeatureName)}).on("mouseover",mouseover).on("mouseout",mouseout),g.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary"),g.selectAll("text").data(layerFeatues).enter().append("text").attr("class","layer1-label").style("fill-opacity",0).style("display","none").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy",".35em").text(function(d){return findprop(d,scope.layerFeatureName)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)})}else"static"==scope.featureNameStyle?(g.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",function(d,i){return color(i)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)}).attr("layer-feature-name",function(d){return findprop(d,scope.layerFeatureName)}),g.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary"),g.selectAll("text").data(layerFeatues).enter().append("text").attr("class","layer1-label").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy",".35em").text(function(d){return findprop(d,scope.layerFeatureName)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)})):(g.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",function(d,i){return color(i)}),g.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary"))});var t=projection.translate(),s=projection.scale(),redraw=function(){var tx=t[0]*d3.event.scale+d3.event.translate[0],ty=t[1]*d3.event.scale+d3.event.translate[1];projection.translate([tx,ty]),projection.scale(s*d3.event.scale),g.selectAll("path").attr("d",path),g.selectAll("text").attr("transform",function(d){return"translate("+path.centroid(d)+")"})};svg.call(d3.behavior.zoom().on("zoom",redraw))}}})}();