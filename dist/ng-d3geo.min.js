!function(){"use strict";function findprop(obj,path){var i,l,args=path.split(".");for(i=0,l=args.length;i<l;i++){if(!obj.hasOwnProperty(args[i]))return;obj=obj[args[i]]}return obj}angular.module("ngD3geo",["rx"]).directive("staticMap",function($parse,$window,observeOnScope){return{restrict:"EA",scope:{data:"=",id:"@",topojsonPath:"@",width:"@",height:"@",bgColor:"@",colorRange:"@",center:"@",scale:"@",layerObjects:"@",layerFeatureName:"@",layerFeatureCode:"@",featureNameStyle:"@"},template:"<svg></svg>",link:function(scope,elem,attrs){var width=scope.width,height=scope.height,d3=$window.d3,rawSvg=elem.find("svg"),svg=d3.select(rawSvg[0]).attr("width",width).attr("height",height).attr("style","outline: thin solid gray;"),g=svg.append("g"),gLayer=g.append("g").attr("id",scope.layerObjects),gLabelLayer=g.append("g").attr("id",scope.layerObjects+"_label"),projection=d3.geo.mercator().center(scope.center.split(",")).scale(scope.scale).translate([width/2,height/2]),path=d3.geo.path().projection(projection);d3.json(scope.topojsonPath,function(error,json){var layerFeatues=topojson.feature(json,json.objects[scope.layerObjects]).features,mesh=topojson.mesh(json,json.objects[scope.layerObjects],function(a,b){return a!==b}),color=d3.scale.linear().domain([1,layerFeatues.length]).interpolate(d3.interpolateHcl).range(scope.colorRange.split(",")),hgrads=g.append("defs").attr("id",scope.layerObjects+"_hdef").selectAll("radialGradient").data(layerFeatues).enter().append("radialGradient").attr("gradientUnits","objectBoundingBox").attr("fx","50%").attr("fy","50%").attr("cx","50%").attr("cy","50%").attr("r","100%").attr("id",function(d){return"hgrad"+findprop(d,scope.layerFeatureCode)});hgrads.append("stop").attr("offset","0%").style("stop-color","white").style("stop-opacity","1"),hgrads.append("stop").attr("offset","100%").style("stop-color",function(d,i){return color(i+1)}).style("stop-opacity","1");var grads=g.append("defs").attr("id",scope.layerObjects+"_def").selectAll("radialGradient").data(layerFeatues).enter().append("radialGradient").attr("gradientUnits","objectBoundingBox").attr("fx","50%").attr("fy","50%").attr("cx","50%").attr("cy","50%").attr("r","35%").attr("id",function(d){return"grad"+findprop(d,scope.layerFeatureCode)});if(grads.append("stop").attr("offset","0%").style("stop-color",function(d,i){return color(i+1)}).style("stop-opacity",".8"),grads.append("stop").attr("offset","100%").style("stop-color",function(d,i){return color(i+1)}).style("stop-opacity","1"),"static"==scope.featureNameStyle){var mouseover=function(p){d3.select(this).style("fill",function(d){return"url(#hgrad"+findprop(d,scope.layerFeatureCode)+")"})},mouseout=function(p){d3.select(this).style("fill",function(d){return"url(#grad"+findprop(d,scope.layerFeatureCode)+")"})};gLayer.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",function(d){return"url(#grad"+findprop(d,scope.layerFeatureCode)+")"}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)}).attr("layer-feature-name",function(d){return findprop(d,scope.layerFeatureName)}).on("mouseover",mouseover).on("mouseout",mouseout),gLayer.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary"),gLabelLayer.selectAll("text").data(layerFeatues).enter().append("text").attr("class","label").attr("pointer-events","none").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy",".35em").text(function(d){return findprop(d,scope.layerFeatureName)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)})}else if("hover"==scope.featureNameStyle){var mouseover=function(p){gLabelLayer.selectAll("text").filter(function(d){return findprop(p,scope.layerFeatureCode)==findprop(d,scope.layerFeatureCode)}).transition().style("fill-opacity",1).style("display","block"),d3.select(this).style("fill",function(d){return"url(#hgrad"+findprop(d,scope.layerFeatureCode)+")"})},mouseout=function(p){gLabelLayer.selectAll("text").filter(function(d){return findprop(p,scope.layerFeatureCode)==findprop(d,scope.layerFeatureCode)}).transition().style("fill-opacity",0).transition().style("display","none"),d3.select(this).style("fill",function(d){return"url(#grad"+findprop(d,scope.layerFeatureCode)+")"})};gLayer.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).style("fill",function(d,i){return"url(#grad"+findprop(d,scope.layerFeatureCode)+")"}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)}).attr("layer-feature-name",function(d){return findprop(d,scope.layerFeatureName)}).on("mouseover",mouseover).on("mouseout",mouseout),gLayer.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary"),gLabelLayer.selectAll("text").data(layerFeatues).enter().append("text").attr("class","label").attr("pointer-events","none").style("fill-opacity",0).style("display","none").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy","-1em").attr("pointer-events","none").text(function(d){return findprop(d,scope.layerFeatureName)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)})}else{var mouseover=function(p){d3.select(this).style("fill",function(d){return"url(#hgrad"+findprop(d,scope.layerFeatureCode)+")"})},mouseout=function(p){d3.select(this).style("fill",function(d){return"url(#grad"+findprop(d,scope.layerFeatureCode)+")"})};gLayer.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",function(d,i){return color(i+1)}).on("mouseover",mouseover).on("mouseout",mouseout),gLayer.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary")}})}}}).directive("2layerMap",function($parse,$window,observeOnScope){return{restrict:"EA",scope:{data:"=",id:"@",topojsonPath:"@",width:"@",height:"@",layer1ColorRange:"@",center:"@",scale:"@",layer1Objects:"@",layer2Objects:"@",layer1FeatureName:"@",layer1FeatureCode:"@",layer2FeatureName:"@",layer2FeatureCode:"@",onReceiveEvents:"&",onStopEvents:"&"},template:"<svg></svg>",link:function(scope,elem,attrs){function reset(){active.classed("active",!1),active=d3.select(null),g.transition().duration(750).style("stroke-width","1.5px").attr("transform",""),gLabelLayer1.selectAll("text").transition().style("display","block").transition().duration(250).style("fill-opacity",1),gLayer2.selectAll("path").transition().style("fill-opacity",0).style("display","none"),scope.onStopEvents()}var width=scope.width,height=scope.height,d3=$window.d3,rawSvg=elem.find("svg"),svg=d3.select(rawSvg[0]).attr("width",width).attr("height",height).attr("style","outline: thin solid gray;");svg.append("rect").attr("class","background").attr("width",width).attr("height",height).on("click",reset);var g=svg.append("g"),gLayer2=g.append("g").attr("id",scope.layer2Objects),gLayer1=g.append("g").attr("id",scope.layer1Objects),gLabelLayer2=g.append("g").attr("id",scope.layer2Objects+"_label"),gLabelLayer1=g.append("g").attr("id",scope.layer1Objects+"_label"),projection=d3.geo.mercator().center(scope.center.split(",")).scale(scope.scale).translate([width/2,height/2]),path=d3.geo.path().projection(projection);d3.json(scope.topojsonPath,function(error,json){var layer1Featues=topojson.feature(json,json.objects[scope.layer1Objects]).features,layer2Featues=topojson.feature(json,json.objects[scope.layer2Objects]).features,meshLayer1=topojson.mesh(json,json.objects[scope.layer1Objects],function(a,b){return a!==b}),color=d3.scale.linear().domain([1,layer1Featues.length]).interpolate(d3.interpolateHcl).range(scope.layer1ColorRange.split(",")),hgrads=g.append("defs").attr("id",scope.layer1Objects+"_hdef").selectAll("radialGradient").data(layer1Featues).enter().append("radialGradient").attr("gradientUnits","objectBoundingBox").attr("fx","50%").attr("fy","50%").attr("cx","50%").attr("cy","50%").attr("r","100%").attr("id",function(d){return"hgrad"+findprop(d,scope.layer1FeatureCode)});hgrads.append("stop").attr("offset","0%").style("stop-color","white").style("stop-opacity","1"),hgrads.append("stop").attr("offset","100%").style("stop-color",function(d,i){return color(i+1)}).style("stop-opacity","1");var grads=g.append("defs").attr("id",scope.layer1Objects+"_def").selectAll("radialGradient").data(layer1Featues).enter().append("radialGradient").attr("gradientUnits","objectBoundingBox").attr("fx","50%").attr("fy","50%").attr("cx","50%").attr("cy","50%").attr("r","35%").attr("id",function(d){return"grad"+findprop(d,scope.layer1FeatureCode)});grads.append("stop").attr("offset","0%").style("stop-color",function(d,i){return color(i+1)}).style("stop-opacity",".8"),grads.append("stop").attr("offset","100%").style("stop-color",function(d,i){return color(i+1)}).style("stop-opacity","1");var mouseoverLayer1=function(p){d3.select(this).style("fill",function(d){return"url(#hgrad"+findprop(d,scope.layer1FeatureCode)+")"})},mouseoutLayer1=function(p){d3.select(this).style("fill",function(d){return"url(#grad"+findprop(d,scope.layer1FeatureCode)+")"})};gLayer2.selectAll("path").data(layer2Featues).enter().append("path").attr("d",path).style("fill",function(d,i){return"url(#grad"+findprop(d,scope.layer1FeatureCode)+")"}).style("fill-opacity",0).style("display","none").attr("layer1-feature-code",function(d){return findprop(d,scope.layer1FeatureCode)}).attr("layer1-feature-name",function(d){return findprop(d,scope.layer1FeatureName)}).attr("layer2-feature-code",function(d){return findprop(d,scope.layer2FeatureCode)}).attr("layer2-feature-name",function(d){return findprop(d,scope.layer2FeatureName)}).attr("class","layer2").on("click",layer2Clicked).on("mouseover",mouseoverLayer2).on("mouseout",mouseoutLayer2),gLabelLayer2.selectAll("text").data(layer2Featues).enter().append("text").attr("class","label").style("fill-opacity",0).style("display","none").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy",".35em").attr("pointer-events","none").text(function(d){return findprop(d,scope.layer2FeatureName)}).attr("layer2-feature-code",function(d){return findprop(d,scope.layer2FeatureCode)}),gLayer1.selectAll("path").data(layer1Featues).enter().append("path").attr("class","layer1").attr("d",path).style("fill",function(d,i){return"url(#grad"+findprop(d,scope.layer1FeatureCode)+")"}).attr("layer1-feature-code",function(d){return findprop(d,scope.layer1FeatureCode)}).attr("layer1-feature-name",function(d){return findprop(d,scope.layer1FeatureName)}).on("click",layer1Clicked).on("mouseover",mouseoverLayer1).on("mouseout",mouseoutLayer1),gLayer1.append("path").datum(meshLayer1).attr("d",path).attr("class","layer1-boundary"),gLabelLayer1.selectAll("text").data(layer1Featues).enter().append("text").attr("class","label").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy",".35em").attr("pointer-events","none").text(function(d){return findprop(d,scope.layer1FeatureName)}).attr("layer1-feature-code",function(d){return findprop(d,scope.layer1FeatureCode)}).on("click",labelClicked)});var active=d3.select(null),layer2Clicked=function(d){if(active.node()&&this.getAttribute("layer1-feature-code")==active.node().getAttribute("layer1-feature-code"))return reset()},labelClicked=function(d){var prevTagName=(this.tagName,""),currentID="";return active.node()&&(prevTagName=active.node().tagName,this.getAttribute("layer1-feature-code")==active.node().getAttribute("layer1-feature-code"))?reset():(currentID=this.getAttribute("layer1-feature-code"),active.classed("active",!1),active=g.selectAll(".layer1").filter(function(d){return findprop(d,scope.layer1FeatureCode)==currentID}).classed("active",!0),void zoom(d))},layer1Clicked=function(d){return active.node()===this?reset():(active.classed("active",!1),active=d3.select(this).classed("active",!0),void zoom(d))},zoom=function(d){var bounds=path.bounds(d),dx=bounds[1][0]-bounds[0][0],dy=bounds[1][1]-bounds[0][1],x=(bounds[0][0]+bounds[1][0])/2,y=(bounds[0][1]+bounds[1][1])/2,scale=.9/Math.max(dx/width,dy/height),translate=[width/2-scale*x,height/2-scale*y];g.transition().duration(750).style("stroke-width",1.5/scale+"px").attr("transform","translate("+translate+")scale("+scale+")"),gLabelLayer1.selectAll("text").transition().style("fill-opacity",0).transition().style("display","none"),gLayer2.selectAll("path").transition().style("fill-opacity",1).style("display","block");var featureCode=findprop(d,scope.layer1FeatureCode);scope.onStopEvents(),scope.onReceiveEvents({feature:featureCode})},mouseoverLayer2=function(p){gLabelLayer2.selectAll("text").filter(function(d){return findprop(p,scope.layer2FeatureCode)==findprop(d,scope.layer2FeatureCode)}).transition().style("fill-opacity",1).style("display","block"),d3.select(this).style("fill",function(d){return"url(#hgrad"+findprop(d,scope.layer1FeatureCode)+")"})},mouseoutLayer2=function(p){gLabelLayer2.selectAll("text").filter(function(d){return findprop(p,scope.layer2FeatureCode)==findprop(d,scope.layer2FeatureCode)}).transition().style("fill-opacity",0).transition().style("display","none"),d3.select(this).style("fill",function(d){return"url(#grad"+findprop(d,scope.layer1FeatureCode)+")"})},styleCircle=g.selectAll("circle"),circleGrads=g.append("defs").attr("id","circle_def").selectAll("radialGradient").data([{id:1}]).enter().append("radialGradient").attr("gradientUnits","objectBoundingBox").attr("fx","50%").attr("fy","50%").attr("cx","50%").attr("cy","50%").attr("r","35%").attr("id",function(d){return"circleGrad"+d.id});circleGrads.append("stop").attr("offset","0%").style("stop-color",function(d,i){return"white"}).style("stop-opacity","1"),circleGrads.append("stop").attr("offset","100%").style("stop-color",function(d,i){return"blue"}).style("stop-opacity",".6");var visualizeEvents=function(data){styleCircle.data(data).enter().append("circle").style("opacity",0).attr("class","circle").style("fill",function(d,i){return"url(#circleGrad1)"}).attr("cx",function(d){return projection(d)[0]}).attr("cy",function(d){return projection(d)[1]}).attr("r",2).transition().delay(function(d,i){return 100*i}).style("opacity",1).transition().delay(function(d,i){return 100*i+250+100}).style("opacity",0).remove()};observeOnScope(scope,"data").subscribe(function(change){if(change.newValue&&change.oldValue)return visualizeEvents(change.newValue)})}}}).directive("eventsMap",function($parse,$window,observeOnScope,$q){return{restrict:"EA",scope:{data:"=",id:"@",topojsonPath:"@",width:"@",height:"@",bgColor:"@",colorRange:"@",center:"@",scale:"@",layerObjects:"@",layerFeatureName:"@",layerFeatureCode:"@"},template:"<svg></svg>",link:function(scope,elem,attrs){var width=scope.width,height=scope.height,d3=$window.d3,rawSvg=elem.find("svg"),svg=d3.select(rawSvg[0]).attr("width",width).attr("height",height).attr("style","outline: thin solid gray;"),g=svg.append("g"),gLayer=g.append("g").attr("id",scope.layerObjects),gLabelLayer=g.append("g").attr("id",scope.layerObjects+"_label"),projection=d3.geo.mercator().center(scope.center.split(",")).scale(scope.scale).translate([width/2,height/2]),path=d3.geo.path().projection(projection);d3.json(scope.topojsonPath,function(error,json){var layerFeatues=topojson.feature(json,json.objects[scope.layerObjects]).features,mesh=topojson.mesh(json,json.objects[scope.layerObjects],function(a,b){return a!==b});gLayer.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",scope.bgColor).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)}),gLayer.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary"),gLabelLayer.selectAll("text").data(layerFeatues).enter().append("text").attr("class","label").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy","-1em");var endall=function(transition,callback){var n=0;transition.each(function(){++n}).each("end",function(){--n||callback.apply(this,arguments)})},showFeatureNames=function(newFeatureCodes){var color=d3.scale.linear().domain([1,newFeatureCodes.length]).interpolate(d3.interpolateHcl).range(scope.colorRange.split(","));gLabelLayer.selectAll("text").filter(function(d){return newFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode))>-1}).text(function(d){return findprop(d,scope.layerFeatureName)}).transition().style("fill-opacity",1).style("display","block").style("fill",function(d,i){d.showname=!0;var index=newFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode));return color(index+1)})},hideFeatureNames=function(){var dfd=$q.defer(),highlightData=gLabelLayer.selectAll("text").filter(function(d){return d.hasOwnProperty("showname")});return 0==highlightData.size()?dfd.resolve():highlightData.transition().style("fill-opacity",0).transition().text(function(d){return d.hasOwnProperty("showname")&&delete d.showname,""}).attr("style",null).call(endall,function(){dfd.resolve()}),dfd.promise},dehighlightFeatures=function(oldFeatureCodes){var dfd=$q.defer(),highlightData=gLayer.selectAll("path").filter(function(d){return d.hasOwnProperty("highlight")});return 0==highlightData.size()?dfd.resolve():highlightData.transition().attr("fill",function(d){return delete d.highlight,scope.bgColor}).call(endall,function(){dfd.resolve()}),dfd.promise},highlightFeatures=function(newFeatureCodes){var color=d3.scale.linear().domain([1,newFeatureCodes.length]).interpolate(d3.interpolateHcl).range(scope.colorRange.split(","));gLayer.selectAll("path").filter(function(d){return newFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode))>-1}).transition().attr("fill",function(d,i){d.highlight=!0;var index=newFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode));return color(index+1)})};observeOnScope(scope,"data").subscribe(function(change){hideFeatureNames().then(function(){change.newValue&&showFeatureNames(change.newValue)}),dehighlightFeatures().then(function(){change.newValue&&highlightFeatures(change.newValue)})})})}}}).directive("zoomPanMap",function($parse,$window){return{restrict:"EA",scope:{data:"=",id:"@",topojsonPath:"@",width:"@",height:"@",colorRange:"@",center:"@",scale:"@",layerObjects:"@",layerFeatureName:"@",layerFeatureCode:"@",featureNameStyle:"@"},template:"<svg></svg>",link:function(scope,elem,attrs){var width=scope.width,height=scope.height,d3=$window.d3,rawSvg=elem.find("svg"),svg=d3.select(rawSvg[0]).attr("width",width).attr("height",height).attr("style","outline: thin solid gray;"),g=svg.append("g"),projection=d3.geo.mercator().center(scope.center.split(",")).scale(scope.scale).translate([width/2,height/2]),path=d3.geo.path().projection(projection);d3.json(scope.topojsonPath,function(error,json){var layerFeatues=topojson.feature(json,json.objects[scope.layerObjects]).features,mesh=topojson.mesh(json,json.objects[scope.layerObjects],function(a,b){return a!==b}),color=d3.scale.linear().domain([1,layerFeatues.length]).interpolate(d3.interpolateHcl).range(scope.colorRange.split(","));if("hover"==scope.featureNameStyle){var mouseover=function(p){g.selectAll("text").filter(function(d){return findprop(p,scope.layerFeatureCode)==findprop(d,scope.layerFeatureCode)}).transition().style("fill-opacity",1).style("display","block")},mouseout=function(p){g.selectAll("text").filter(function(d){return findprop(p,scope.layerFeatureCode)==findprop(d,scope.layerFeatureCode)}).transition().style("fill-opacity",0).transition().style("display","none")};g.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",function(d,i){return color(i+1)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)}).attr("layer-feature-name",function(d){return findprop(d,scope.layerFeatureName)}).on("mouseover",mouseover).on("mouseout",mouseout),g.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary"),g.selectAll("text").data(layerFeatues).enter().append("text").attr("class","label").style("fill-opacity",0).style("display","none").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy","-1em").attr("pointer-events","none").text(function(d){return findprop(d,scope.layerFeatureName)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)})}else"static"==scope.featureNameStyle?(g.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",function(d,i){return color(i+1)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)}).attr("layer-feature-name",function(d){return findprop(d,scope.layerFeatureName)}),g.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary"),g.selectAll("text").data(layerFeatues).enter().append("text").attr("class","label").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy",".35em").text(function(d){return findprop(d,scope.layerFeatureName)}).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)})):(g.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",function(d,i){return color(i+1)}),g.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary"))});var t=projection.translate(),s=projection.scale(),redraw=function(){var tx=t[0]*d3.event.scale+d3.event.translate[0],ty=t[1]*d3.event.scale+d3.event.translate[1];projection.translate([tx,ty]),projection.scale(s*d3.event.scale),g.selectAll("path").attr("d",path),g.selectAll("text").attr("transform",function(d){return"translate("+path.centroid(d)+")scale("+d3.event.scale+")"})};svg.call(d3.behavior.zoom().on("zoom",redraw))}}}).directive("routeEventsMap",function($parse,$window,observeOnScope,$q){return{restrict:"EA",scope:{data:"=",id:"@",topojsonPath:"@",width:"@",height:"@",bgColor:"@",colorRange:"@",topNumber:"@",center:"@",scale:"@",layerObjects:"@",layerFeatureName:"@",layerFeatureCode:"@"},template:"<svg></svg>",link:function(scope,elem,attrs){var width=scope.width,height=scope.height,d3=$window.d3,rawSvg=elem.find("svg"),svg=d3.select(rawSvg[0]).attr("width",width).attr("height",height).attr("style","outline: thin solid gray;"),g=svg.append("g"),gLayer=g.append("g").attr("id",scope.layerObjects),gLabelLayer=g.append("g").attr("id",scope.layerObjects+"_label"),projection=d3.geo.mercator().center(scope.center.split(",")).scale(scope.scale).translate([width/2,height/2]),path=d3.geo.path().projection(projection),color=d3.scale.linear().domain([1,parseInt(scope.topNumber)]).interpolate(d3.interpolateHcl).range(scope.colorRange.split(",")),fromGrads=g.append("defs").attr("id","from_def").selectAll("linearGradient").data(d3.range(1,parseInt(scope.topNumber)+1)).enter().append("linearGradient").attr("gradientUnits","linearGradient").attr("x1","100%").attr("y1","0%").attr("x2","0%").attr("y2","0%").attr("id",function(d,i){return"fromGrad"+(i+1)});fromGrads.append("stop").attr("offset","0%").style("stop-color","white").style("stop-opacity","1"),fromGrads.append("stop").attr("offset","100%").style("stop-color",function(d,i){return color(i+1)}).style("stop-opacity","1");var toGrads=g.append("defs").attr("id","to_def").selectAll("linearGradient").data(d3.range(1,parseInt(scope.topNumber)+1)).enter().append("linearGradient").attr("gradientUnits","linearGradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("id",function(d,i){return"toGrad"+(i+1)});toGrads.append("stop").attr("offset","0%").style("stop-color","white").style("stop-opacity","1"),toGrads.append("stop").attr("offset","100%").style("stop-color",function(d,i){return color(i+1)}).style("stop-opacity","1"),d3.json(scope.topojsonPath,function(error,json){var layerFeatues=topojson.feature(json,json.objects[scope.layerObjects]).features,mesh=topojson.mesh(json,json.objects[scope.layerObjects],function(a,b){return a!==b});gLayer.selectAll("path").data(layerFeatues).enter().append("path").attr("class","layer1").attr("d",path).attr("fill",scope.bgColor).attr("layer-feature-code",function(d){return findprop(d,scope.layerFeatureCode)}),gLayer.append("path").datum(mesh).attr("d",path).attr("class","layer1-boundary"),gLabelLayer.selectAll("text").data(layerFeatues).enter().append("text").attr("class","label").attr("transform",function(d){return"translate("+path.centroid(d)+")"}).attr("dy","-1em");var endall=function(transition,callback){var n=0;transition.each(function(){++n}).each("end",function(){--n||callback.apply(this,arguments)})},showFeatureNames=function(newValue){var fromFeatureCodes=extractCodes(newValue,"from_code"),toFeatureCodes=extractCodes(newValue,"to_code");gLabelLayer.selectAll("text").filter(function(d){return fromFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode))>-1||toFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode))>-1}).text(function(d){var fromIndex=fromFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode)),toIndex=toFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode));return fromIndex>-1?fromIndex+1+"_"+findprop(d,scope.layerFeatureName):toIndex>-1?toIndex+1+"_"+findprop(d,scope.layerFeatureName):void 0}).transition().style("fill-opacity",1).style("display","block").style("fill",function(d,i){d.showname=!0;var fromIndex=fromFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode)),toIndex=toFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode));return fromIndex>-1?"url(#fromGrad"+(fromIndex+1)+")":toIndex>-1?"url(#toGrad"+(toIndex+1)+")":void 0})},highlightFeatures=function(newValue){var fromFeatureCodes=extractCodes(newValue,"from_code"),toFeatureCodes=extractCodes(newValue,"to_code");gLayer.selectAll("path").filter(function(d){return fromFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode))>-1||toFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode))>-1}).transition().attr("fill",function(d,i){d.highlight=!0;var fromIndex=fromFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode)),toIndex=toFeatureCodes.indexOf(findprop(d,scope.layerFeatureCode));return fromIndex>-1?color(fromIndex+1):toIndex>-1?color(toIndex+1):void 0})},hideFeatureNames=function(){var dfd=$q.defer(),highlightData=gLabelLayer.selectAll("text").filter(function(d){return d.hasOwnProperty("showname")});return 0==highlightData.size()?dfd.resolve():highlightData.transition().style("fill-opacity",0).transition().text(function(d){return d.hasOwnProperty("showname")&&delete d.showname,""}).attr("style",null).call(endall,function(){dfd.resolve()}),dfd.promise},dehighlightFeatures=function(oldFeatureCodes){var dfd=$q.defer(),highlightData=gLayer.selectAll("path").filter(function(d){return d.hasOwnProperty("highlight")});return 0==highlightData.size()?dfd.resolve():highlightData.transition().attr("fill",function(d){return delete d.highlight,scope.bgColor}).call(endall,function(){dfd.resolve()}),dfd.promise},extractCodes=function(routes,key){var featureCodes=[];return routes?(routes.forEach(function(entry){featureCodes.push(entry[key])}),featureCodes):featureCodes};observeOnScope(scope,"data").subscribe(function(change){hideFeatureNames().then(function(){change.newValue&&showFeatureNames(change.newValue)}),dehighlightFeatures().then(function(){change.newValue&&highlightFeatures(change.newValue)})})})}}})}();